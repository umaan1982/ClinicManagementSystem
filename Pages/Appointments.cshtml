@page
@model ClinicManagementSystem.Pages.AppointmentsModel
@using System.Data;
@using ClinicManagementSystem.Models;
@{
}


<div>
    <h4>Appointments</h4>
    <div>
        <button type="button" class="btn btn-primary" onclick="CreateNewAppointment()" style="float:right">Create New Appointment</button>
    </div>
    <div class="modal" id="AddModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Appointment</h5>
                </div>
                <div class="modal-body">
                    <div><strong>Id:</strong>(Use different Id)</div>
                    <input type="number" id="Id" class="form-control input-lg" />
                    <div><strong>Name:</strong></div>
                    <input type="text" id="PatientText" class="form-control input-lg" />
                    <div><strong>Appointment Date:</strong></div>
                    <input type="datetime-local" id="TimeDuration" class="form-control input-lg" />
                </div>
                <div class="modal-footer">
                    <button type="button" id="AddButton" class="btn btn-primary">Add Appointment</button>
                    <button type="button" id="CloseButton" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    @if(Model.appointsments.Count > 0)
    {
        <table id="Modeltable" class="table table-hover table-striped arrowes-table">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Patient Name</th>
                    <th>Appointment Date</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                @foreach (Appointment appointment in Model.appointsments)
                {
                    <tr>
                        <td>@appointment.Id</td>
                        <td>@appointment.patient_Name</td>
                        <td>@appointment.AppointmentDate</td>
                        <td><button id="DeleteButton" onclick="DeleteFunction(@appointment.Id)"><img src="/assets/delete.png" style="height:30px" /></button></td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>



@Html.AntiForgeryToken()
@section Scripts{
    <script>
        $(document).ready(function() {
            $('#Modeltable').dataTable();
        });

        function CreateNewAppointment() {
            $("#AddModal").modal('show');
        }
        $("#CloseButton").on('click', function() {
            $("#AddModal").modal('hide');
        })

        $("#AddButton").on('click', function() {
            const data = {
                id: document.getElementById("Id").value,
                patientname: document.getElementById("PatientText").value,
                appointmentdate: document.getElementById("TimeDuration").value
            }
            console.log(data);
            let json = JSON.stringify(data);
            console.log(json);
            fetch("Appointments?handler=AddAppointment", {
                method: 'POST',
                headers: {
                    RequestVerificationToken:
                        $('input:hidden[name="__RequestVerificationToken"]').val(),
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                },
                body: json
            })
                .then((response) => {
                    if (response.status == 500) {
                        throw new Error('Server failed');
                    }
                    if (response.status == 400) {
                        throw new Error('Log in failed');
                    }
                    return response.json();
                })
                .then((data) => {
                    alert("Add successful");
                    window.location.reload();
                })
                .catch((error) => {
                    alert("Adding Medicine failed");
                    console.error(error);
                })

        })

        function DeleteFunction(id) {
            const data = {
                id: id
            }

            let json = JSON.stringify(data);

            if (confirm("Are you sure you want to delete it?")) {
                fetch("Appointments?handler=DeleteAppointment", {
                    method: 'POST',
                    headers: {
                        RequestVerificationToken:
                            $('input:hidden[name="__RequestVerificationToken"]').val(),
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                    },
                    body: json
                })
                    .then((response) => {
                        if (response.status == 500) {
                            throw new Error('Server failed');
                        }
                        if (response.status == 400) {
                            throw new Error('Log in failed');
                        }
                        return response.json();
                    })
                    .then((data) => {
                        alert("Delete successful");
                        window.location.reload();
                    })
                    .catch((error) => {
                        alert("Deleting Medicine failed");
                        console.error(error);
                    })

            }
            else {

            }
        }
    </script>
}